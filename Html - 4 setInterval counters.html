<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Prod App</title>
</head>
<body>
    <header>
        <h1>workTIMER</h1>
    </header>
    <main>
        <div class="input box">
            <h2>Working method for today</h2>
            <h1>Suggested total time per work: 4 hrs</h1>
            <!-- <select name="dropdown" id="dropdown">
                <option value="Choose one">Choose one</option>
                <option value="Practice/Project">Practice/Project</option>
                <option value="Learn">Learn</option>
                <option value="Both">Both</option>
            </select> -->
        <div class="actions">
            <form id="forma" action="" autocomplete="on">
                <div class="options">

                    <label class="select">
                        Select one:
                    </label>
                        <label class="tempo select" for="tempo">
                            Hours:
                        </label>
                    
                        <label for="coding">
                            <input class="check 1" id="coding" type="checkbox" name="input" value="coding">Coding
                        </label>
                            <label class="tempo" for="tempo">
                                <input class="number 1" type="number" id="tempo" disabled>
                            </label>

                        <label for="learning">
                            <input class="check 2" id="learning" type="checkbox" name="input" value="learning">Learning
                        </label>
                            <label class="tempo" for="tempo">
                                <input class="number 2" type="number" id="tempo" disabled>
                            </label>

                        <label for="practice">
                            <input class="check 3" id="practice" type="checkbox" name="input" value="practice">Practice
                        </label>
                            <label class="tempo" for="tempo">
                                <input class="number 3" type="number" id="tempo" disabled>
                            </label>

                        <label for="project">
                            <input class="check 4" id="project" type="checkbox" name="input" value="project">Project
                        </label>
                            <label class="tempo" for="tempo">
                                <input class="number 4" type="number" id="tempo" disabled>
                            </label>
                        <!--
                        <label for="other">
                            <input class="check" id="other" type="text" name="input" value="" placeholder="Another task">
                        </label>
                            <label class="tempo" for="tempo">
                                <input type="number" id="tempo">
                            </label>
                        -->
                </div>
                <label class="another" for="another">
                    <input class="another" id="another" type="button" name="input" value="Add task">
                </label>
            </form>
            <div class="buttons">
                <button id="play" type="button" onclick="start()" disabled>START</button>
                <button id="pause" type="button" onclick="stop()" disabled>PAUSE</button>
                <button id="end" type="button" onclick="finish()" disabled>END</button>
            </div>
        </div>
        </div>
        <div class="time box">
            <h2 id="time-message">Not Started</h2>
            <h1 class="" id="display">00:00:00</h1>
        </div>
        <div class="start-end">
            <div class="timing start"><p>Start Time:&emsp;</p><p id="start-hour">--:-- ----</p></div>
            <div class="timing end"><p>End Time:&emsp;</p><p id="end-hour">--:-- ----</p></div>
            <div class="timing hour"><p>Time:&emsp;</p><p id="time">00:00 a.m</p></div>
        </div>
        <div class="state">
            <div>
            <p id="state-title">Today to-do list</p>
                <div class="options tasks">
                    <p>Order</p>
                    <p>Task</p>
                    <p>Hours</p>
                </div>
            </div>
        </div>
        <div class="state centered">
            <div>
            <p>You are working on</p>
            <h2><span>Coding</span><br> at CodeWars</h2>
            </div>
        </div>
        <div class="state next">
            <div>
            <p>Next task:</p>
            <h2>PROJECT</h2>
            </div>
        </div>
    </main>
    <footer>
        <script>
                const play = document.getElementById("play");
                const pause = document.getElementById("pause");
                const end = document.getElementById("end");
                let display = document.getElementById("display");
                let startDisplay = document.getElementById("start-hour");
                let endDisplay = document.getElementById("end-hour");
                let timeDisplay = document.getElementById("time");
                let cronometro = "";
                let hours = 0;
                let minutes = 0;
                let seconds = 0;
                let hidden = 0;
                let visible = 0;
                let standby = 0;
                let timer = 0;
                let timerPopup = 0; 
                let hoursPopup = 0;
                let minutesPopup = 0;
                let secondsPopup = 0;
                let hour = 0;
                let ampm = "";
                const array = [];
                let ol = document.createElement("ol");
                

window.addEventListener("load", () => { 
    setTimeout(() => {
        Notification.requestPermission().then((permission) => {
                    if (permission === "granted") {
                        const notification = new Notification("workTIMER will send you notifications", {
                            body: "It's glad to help you focusing on your work!"
                        });
                        setTimeout(() => {
                            notification.close();                                                                   
                              /*  
                                document.getElementsByClassName("time")[0].addEventListener("click", () => {
                                if (play.disabled == false) start();
                                else stop();*/
                                                                
                        }, 4000);
                    }
        });
    }, 2000);
                });

            
setInterval(() => {
    //------------ HORA ACTUAL
                hour = new Date();
                minuteEnd = hour.getMinutes();
                hourEnd = hour.getHours();
                if (minuteEnd < 10) minuteEnd = "0" + minuteEnd;
                if (hourEnd < 12) ampm = "a.m."; else ampm = "p.m.";
                if (hourEnd == 0) {
                    hourEnd = 12;
                } else if (hourEnd > 12) {
                    hourEnd-= 12;
                }
                if (hourEnd < 10) hourEnd = "0" + hourEnd;
                if (play.textContent === "START") {
                    time.textContent = `${hourEnd}:${minuteEnd} ${ampm}`;
                }
                //------------
        if (hour.getSeconds() == 0) {
            document.getElementsByClassName("timing")[2].style.backgroundColor = "rgba(255,255,255,.7)";
        }
    
}, 500);


            document.addEventListener("visibilitychange",() => {
                    if (pause.disabled == false) {
                        timer = hours * 3600 + minutes*60 + seconds;
                        if (document.hidden) {
                            hidden = Date.now()/1000; 
                        } else {visible = Date.now()/1000; 
                            console.log("timer", timer)
                        }
        
                        standby = Math.round(visible - hidden);
                        if(standby>0){
                            console.log(standby)
                            timer+= standby;   
                        }
                        hours = Math.floor(timer / 3600);
                        minutes = Math.floor(((timer / 3600) - hours)*60);
                        seconds = Math.floor((((timer / 3600) - hours)*60 - minutes)*60);

                    }
                });

                // PROBAR notifications API y esto: 
                ////onclick = comillas myWin = window.open('','winName','location=0,width=300,height=214'); myWin.focus();
    function crono() { 
            if (document.visibilityState === "visible") {

                if(seconds == 59) {
                    seconds = 0;
                    if(minutes == 59) {
                        minutes = 0;
                        hours++;
                    } else minutes++;
                } else seconds++;
                if (seconds > 59) seconds-=60;
               // console.log(minutes,seconds,hours)
            // display
                if (seconds < 10 && minutes < 10 && hours < 10)
                display.textContent = `${"0"+hours}:${"0"+minutes}:${"0"+seconds}`;
                else if (minutes < 10 && hours < 10)
                display.textContent = `${"0"+hours}:${"0"+minutes}:${seconds}`;
                else if (hours < 10 && seconds < 10)
                display.textContent = `${"0"+hours}:${minutes}:${"0"+seconds}`;
                else if (minutes < 10 && seconds < 10)
                display.textContent = `${hours}:${"0"+minutes}:${"0"+seconds}`;
                else if (hours < 10)
                display.textContent = `${"0"+hours}:${minutes}:${seconds}`;
                else display.textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            timerPopup++;  
            hoursPopup = Math.floor(timerPopup / 3600);
            minutesPopup = Math.floor(((timerPopup / 3600) - hoursPopup)*60);
            secondsPopup = Math.floor((((timerPopup / 3600) - hoursPopup)*60 - minutesPopup)*60);
        if (minutesPopup % 5 === 0 && minutesPopup !== 0 && secondsPopup == 59) {
                Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                    notification = new Notification("workTIMER / Actual task: CODING", {
                        body: `${hoursPopup} h  :  ${minutesPopup} m  :  ${secondsPopup} s`,
                        
                    });
                    notification.addEventListener("click", () => {
                        window.focus();
                        notification.close();
                    });
                }
            })
        } // This last IF maintains the code running, since browser stops when tab is inactive
        if (minutesPopup === 30 && secondsPopup == 0) {
                Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                    notification = new Notification("30 minutes more", {
                        body: `${hoursPopup} h  :  ${minutesPopup} m`,
                        
                    });
                    notification.addEventListener("click", () => {
                        window.focus();
                        notification.close();
                    });
                }
            })
        } 
        if (minutesPopup === 59 && secondsPopup == 59) {
                Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                    notification = new Notification(`${hoursPopup} hours completed`, {
                        body: `${hoursPopup} h  :  ${minutesPopup} m`,
                        
                    });
                    notification.addEventListener("click", () => {
                        window.focus();
                        notification.close();
                    });
                }
            })
        } 
  
        //popUp = window.open('','_parent','location=0,width=300,height=214'); popUp.focus();
        
    }// funcion crono

            function start() {
                cronometro = setInterval(crono, 1000);
                document.getElementById("time-message").textContent = "Running";
                //------------ START TIME
                hour = new Date();
                minuteEnd = hour.getMinutes();
                hourEnd = hour.getHours();
                if (minuteEnd < 10) minuteEnd = "0" + minuteEnd;
                if (hourEnd < 12) ampm = "a.m."; else ampm = "p.m.";
                if (hourEnd == 0) {
                    hourEnd = 12;
                } else if (hourEnd > 12) {
                    hourEnd-= 12;
                }
                if (hourEnd < 10) hourEnd = "0" + hourEnd;
                if (play.textContent === "START") {
                    startDisplay.textContent = `${hourEnd}:${minuteEnd} ${ampm}`;
                    document.getElementsByClassName("timing")[0].style.backgroundColor = "rgba(255,255,255,.7)";
                    endDisplay.textContent = `--:-- ----`;
                    Array.from(document.getElementsByClassName("check")).forEach(x => x.disabled = true);
                    Array.from(document.getElementsByClassName("number")).forEach(y => y.disabled = true);
                    document.getElementById("another").disabled = true;
                }
                //------------
                pause.disabled = false;
                play.disabled = true;
                end.disabled = false;
                end.textContent = "END";
                document.getElementsByClassName("time")[0].classList.remove("timend");
            }          
            
            //------------ Aquí se apaga la luz de los avisos de horas de inicio, fin y hora actual
            const timings = Array.from(document.querySelectorAll(".timing"));
            timings.forEach((timing,i) => timing.addEventListener("transitionend", () => {
                document.getElementsByClassName("timing")[i].style.backgroundColor = "rgba(0,0,0,0)";
            }))

            //------------ Aquí se toma el orden de los checkboxes
            const checkboxes = Array.from(document.querySelectorAll(".check"));
            checkboxes.forEach((checkbox,i) => checkbox.addEventListener("click", () => {
                document.getElementsByClassName("tasks")[0].appendChild(ol);
                let li = "";
                inputHour = document.getElementsByClassName(i+1)[1];
                if (checkbox.checked == true) {
                    inputHour.disabled = false;
                    inputHour.focus();
                    inputHour.required = true;
                    li = document.createElement('li');
                    ol.appendChild(li);
                    li.appendChild(document.createTextNode(checkbox.value));
                    array.push(checkbox.value);
                    console.log(array)
                }
                else {
                    inputHour.disabled = true;
                    inputHour.required = false;
                    inputHour.value = "";
                    if (ol.hasChildNodes()) {
                        ol.removeChild(ol.children[array.indexOf(checkbox.value)]);
                    }
                    array.splice(array.indexOf(checkbox.value),1);
                    console.log(array)
                }
            if (array.length >= 1 && (array.length == hourList.filter(x => x.value).length)) play.disabled = false;
            else play.disabled = true;
                //console.log(ol)
            }))

            //------------ Aquí se habilita el boton START si los checkboxes y horas son iguales
            let hourList = Array.from(document.getElementsByClassName("number"));
            hourList.forEach(item => item.addEventListener("input", () => {
                    
                    if (array.length >= 1 && (array.length == hourList.filter(x => x.value).length)) play.disabled = false;
                    else play.disabled = true;
                    
                    console.log(hourList.filter(x => x.value).length)
                    
                }));
            
            
            //------------ Aquí se crean opciones input text
            document.getElementById("another").onclick = () => {
                //------------ Inputs de task
                let label = document.createElement("label");
                let another = document.createElement("input");
                another.type = "text";
                another.classList.add("new-input","check");
                another.id = "other";  // REVISAR PORQUE TODOS SALEN CON MISMA ID
                label.htmlFor = "other";
                label.appendChild(another);
                document.getElementsByClassName("options")[0].appendChild(label);
                array.push(another.value);
                console.log(array);
                // Chequeo para habilitar el boton
                if (array.length >= 1 && (array.length == hourList.filter(x => x.value).length)) play.disabled = false;
                else play.disabled = true;
                //------------ Inputs de horas
                let labelHours = document.createElement("label");
                let anotherHours = document.createElement("input");
                anotherHours.type = "number";
                anotherHours.id = "tempo";
                anotherHours.disabled = true;
                anotherHours.classList.add("number","new-number");
                labelHours.htmlFor = "tempo";
                labelHours.classList.add("tempo");
                labelHours.appendChild(anotherHours);
                document.getElementsByClassName("options")[0].appendChild(labelHours);
                another.focus();

                //------------ Se habilitan los inputs de horas al escribir en los nuevos input text

                const newInputs = Array.from(document.getElementsByClassName("new-input"));
                newInputs.forEach((ite,j) => ite.addEventListener("input", () => {
                    console.log(newInputs);
                    if (ite.value) {
                        document.getElementsByClassName("number")[j+4].disabled = false;
                        array[j] = ite.value;
                        console.log(array)
                    }
                    else {
                        ite.parentElement.remove();
                        document.getElementsByClassName("new-number")[j].parentElement.remove();
                        //array.splice(j,1);
                        console.log(array)
                    }
                    // Chequeo para habilitar el boton
                    if (array.length >= 1 && (array.length == hourList.filter(x => x.value).length)) play.disabled = false;
                        else play.disabled = true;

                    /*
                    if (array.length >= 1 && (array.length == hourList.filter(x => x.value).length)) play.disabled = false;
                    else play.disabled = true;
                    */
                    //console.log("ok")/*newInputs.filter(k => k.value)*/
                    
                }));
                
                hourList = Array.from(document.getElementsByClassName("number"));
                hourList.forEach((item,h) => item.addEventListener("input", () => {
                    // Chequeo para habilitar el boton
                    if (array.length >= 1 && (array.length == hourList.filter(x => x.value).length)) play.disabled = false;
                    else play.disabled = true;

                    console.log(array)
                    
                }));
                
            } //----- Creador de INPUTS


            function stop() {
                clearInterval(cronometro);
                pause.disabled = true;
                play.disabled = false;
                play.textContent = "RESTART";
                document.getElementById("time-message").textContent = "Paused";
            }


            function finish() {
                if (end.textContent == "END"){
                    stop();
                    play.disabled = true;
                   /* end.disabled = true;*/
                    //------------
                    document.getElementsByClassName("time")[0].classList.add("timend");
                    //------------
                    //------------
                    hour = new Date();
                    minuteEnd = hour.getMinutes();
                    hourEnd = hour.getHours();
                    if (minuteEnd < 10) minuteEnd = "0" + minuteEnd;
                    if (hourEnd < 12) ampm = "a.m."; else ampm = "p.m.";
                    if (hourEnd == 0) {
                        hourEnd = 12;
                    } else if (hourEnd > 12) {
                        hourEnd-= 12;
                    }
                    if (hourEnd < 10) hourEnd = "0" + hourEnd;
                    endDisplay.textContent = `${hourEnd}:${minuteEnd} ${ampm}`;
                    //------------
                    document.getElementsByClassName("timing")[1].style.backgroundColor = "rgba(255,255,255,.7)";
                    end.textContent = "RESET";
                    document.getElementById("time-message").style.display = "none";
                } else location.reload();
            }
        </script>
        <h2>workTIMER</h2>
    </footer>
</body>
</html>